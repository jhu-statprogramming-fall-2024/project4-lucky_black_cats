<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Stock Market Calculator</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="project4_files/libs/clipboard/clipboard.min.js"></script>
<script src="project4_files/libs/quarto-html/quarto.js"></script>
<script src="project4_files/libs/quarto-html/popper.min.js"></script>
<script src="project4_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="project4_files/libs/quarto-html/anchor.min.js"></script>
<link href="project4_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="project4_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="project4_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="project4_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="project4_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Stock Market Calculator</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="project-4-using-wikipedia-data-to-predict-stock-prizes" class="level1">
<h1>Project 4: Using Wikipedia Data to Predict Stock Prizes</h1>
<p>Team Members:</p>
<ul>
<li><p>Mateo Bandala Jacques | abandal1@jh.edu</p></li>
<li><p>María Camila Restrepo | mrestre@jh.edu</p></li>
<li><p>Mitali Joshi | mjoshi13@jh.edu</p></li>
</ul>
<section id="research-question" class="level2">
<h2 class="anchored" data-anchor-id="research-question">Research question</h2>
<p>Can machine learning methods be used to build an equation that accurately predicts variation in stock prices based on hits to a related Wikipedia page?</p>
</section>
<section id="importance-and-previous-literature" class="level2">
<h2 class="anchored" data-anchor-id="importance-and-previous-literature">Importance and previous literature</h2>
<p>Generating revenue through the stock exchange is vital for economic growth, allowing companies to raise capital and providing investors with opportunities to grow wealth. Stock market drives business expansion, job creation, and the allocation of resources to high-potential industries.</p>
<p>The potential to predict stock price movements using machine learning methods based on digital engagement metrics has been explored, with prior research focusing largely on Google search data. Stock prices are influenced by factors like public perception, market sentiment, and media coverage. While major events often lead to spikes in page views, smaller, gradual changes in engagement may offer predictive signals for price fluctuations.</p>
<p>Huang et al <span class="citation" data-cites="huang2020">(<a href="#ref-huang2020" role="doc-biblioref">Huang, Rojas, and Convery 2020</a>)</span>, developed a trade strategy based on the use of Google Trends for the prediction of stock movements through linear regression models, outperforming traditional buy-and-hold strategies by 40%. Similarly, Shivers et al <span class="citation" data-cites="shivers">(<a href="#ref-shivers" role="doc-biblioref">Shivers, n.d.</a>)</span>. demonstrated a correlation between increased Google search activity and stock price changes, using efficient methods to collect and analyze historical data. Other studies have employed machine learning techniques to assess the predictive power of media data, finding that increased media interest often precedes significant stock price changes.<span class="citation" data-cites="szczygielski2024">(<a href="#ref-szczygielski2024" role="doc-biblioref">Szczygielski et al. 2024</a>)</span>.</p>
<p>The literature indicates that machine learning can effectively leverage media data to forecast stock behavior. However, the cost and complexity of accessing Google search data pose challenges. Wikipedia offers an accessible and transparent alternative. It is widely used globally as source of information, thus serving as a proxy for public interest and sentiment toward a company or sector. Its community-curated content may reduce biases associated with commercial platforms like Google. Although there are other sources that could be used to better measure public interest (such as: the app formerly known as Twitter†, Google, or TikTok), their API protocols are complex and it is difficult to extract data, while Wikipedia’s metadata, including page view statistics, is easy to access.</p>
<p>By developing a predictive model that correlates Wikipedia page views with stock price fluctuations, this study aims to uncover new insights into how public attention influences financial markets. This research not only highlights Wikipedia’s potential as a cost-effective and robust data source but also advances understanding of unconventional data in financial modeling, with implications for investors, analysts, and economic forecasting. And by making our model available through a user-friendly interface, we hope to make financial insights more accessible to a wider audience.</p>
</section>
<section id="data-sources-and-description" class="level2">
<h2 class="anchored" data-anchor-id="data-sources-and-description">Data sources and description</h2>
<p>The main inputs we will be using for our models will be Wikipedia’s daily page view data and stock data from Yahoo Finance.</p>
<p>We will retrieve Wikipedia’s page view data using the Wikimedia REST API, an open-source and collaborative repository <span class="citation" data-cites="wikimedia">(<a href="#ref-wikimedia" role="doc-biblioref">Foundation, n.d.</a>)</span>. Specifically, we will use the endpoint for fetching per-article page views: https://wikimedia.org/api/rest_v1/metrics/pageviews/per-article/ . This API supports requests for page views by article, date, and access method, and it imposes a rate limit of no more than 200 requests per second. Stock market data will be obtained from Yahoo Finance, a free resource for financial data <span class="citation" data-cites="yahoo">(<a href="#ref-yahoo" role="doc-biblioref">Yahoo, n.d.</a>)</span>. In R, we can use the quantmod package, which provides tools for quantitative financial modeling and trading. This package includes functions to access Yahoo Finance data. To retrieve stock data, we must specify the ticker, a unique set of letters or characters assigned to a publicly traded company’s stock. While Yahoo previously offered an official API, it was discontinued in 2017.</p>
</section>
<section id="goal-analytic-product" class="level2">
<h2 class="anchored" data-anchor-id="goal-analytic-product">Goal: Analytic product</h2>
<p>The final analytic product will be an RShiny app. The user interface will allow the client to select a stock ticker (e.g: TSLA for TESLA), and a Wikipedia page (e.g: Elon Musk). The app will then output a normalized graph comparing Wikipedia page views with Stock price for the selected ticker. Below the output plot, there will be a graph with the results from the machine learning, displaying the expected change on stock price for the next day based on the previous seven days, along with a simple prediction of whether the stock is expected to increase (ie, UP) or decrease (ie, DOWN) on the day following the end of the interval selected by the client.</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"tidyverse"</span>)) <span class="fu">install.packages</span>(<span class="st">"tidyverse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: tidyverse</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.1     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"httr"</span>)) <span class="fu">install.packages</span>(<span class="st">"httr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: httr</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"jsonlite"</span>)) <span class="fu">install.packages</span>(<span class="st">"jsonlite"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: jsonlite

Attaching package: 'jsonlite'

The following object is masked from 'package:purrr':

    flatten</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"quantmod"</span>)) <span class="fu">install.packages</span>(<span class="st">"quantmod"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: quantmod</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'quantmod' was built under R version 4.4.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: xts</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'xts' was built under R version 4.4.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: zoo

Attaching package: 'zoo'

The following objects are masked from 'package:base':

    as.Date, as.Date.numeric


######################### Warning from 'xts' package ##########################
#                                                                             #
# The dplyr lag() function breaks how base R's lag() function is supposed to  #
# work, which breaks lag(my_xts). Calls to lag(my_xts) that you type or       #
# source() into this session won't work correctly.                            #
#                                                                             #
# Use stats::lag() to make sure you're not using dplyr::lag(), or you can add #
# conflictRules('dplyr', exclude = 'lag') to your .Rprofile to stop           #
# dplyr from breaking base R's lag() function.                                #
#                                                                             #
# Code in packages is not affected. It's protected by R's namespace mechanism #
# Set `options(xts.warn_dplyr_breaks_lag = FALSE)` to suppress this warning.  #
#                                                                             #
###############################################################################

Attaching package: 'xts'

The following objects are masked from 'package:dplyr':

    first, last

Loading required package: TTR</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'TTR' was built under R version 4.4.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Registered S3 method overwritten by 'quantmod':
  method            from
  as.zoo.data.frame zoo </code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"dplyr"</span>)) <span class="fu">install.packages</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"caret"</span>)) <span class="fu">install.packages</span>(<span class="st">"caret"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: caret</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'caret' was built under R version 4.4.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: lattice

Attaching package: 'caret'

The following object is masked from 'package:httr':

    progress

The following object is masked from 'package:purrr':

    lift</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"shiny"</span>)) <span class="fu">install.packages</span>(<span class="st">"shiny"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: shiny

Attaching package: 'shiny'

The following object is masked from 'package:jsonlite':

    validate</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"rsconnect"</span>)) <span class="fu">install.packages</span>(<span class="st">"rsconnect"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: rsconnect</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'rsconnect' was built under R version 4.4.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'rsconnect'

The following object is masked from 'package:shiny':

    serverInfo</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quantmod)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsconnect)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
First, we will build and validate the predictive model that will go in our user interface
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
</section>
<section id="part-1-train-and-test-a-machine-learning-algorithm-to-predict-stock-prizes" class="level2">
<h2 class="anchored" data-anchor-id="part-1-train-and-test-a-machine-learning-algorithm-to-predict-stock-prizes">Part 1: Train and test a machine learning algorithm to predict stock prizes</h2>
</section>
<section id="set-up-the-functions-to-extract-the-data" class="level2">
<h2 class="anchored" data-anchor-id="set-up-the-functions-to-extract-the-data">Set-up the functions to extract the data</h2>
<p>From Wikipedia, we will extract the daily page views for a given page. From Yahoo Finance, we will extract the daily stock closing prices for a given ticker. This will take the user’s inputs of the page name, ticker, and date range, and return the relevant data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First, we will create a function to get the Wikipedia page views</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>get_wiki_pageviews <span class="ot">&lt;-</span> <span class="cf">function</span>(page, start_date, end_date) {                <span class="co"># Input page and dates</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  page <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, page)  <span class="co"># Fix the URL name</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://wikimedia.org/api/rest_v1/metrics/pageviews/per-article/"</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"en.wikipedia/all-access/all-agents/"</span>, page, <span class="st">"/daily/"</span>,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">format</span>(<span class="fu">as.Date</span>(start_date), <span class="st">"%Y%m%d"</span>), <span class="st">"/"</span>, <span class="fu">format</span>(<span class="fu">as.Date</span>(end_date), <span class="st">"%Y%m%d"</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> <span class="fu">GET</span>(url)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">status_code</span>(response) <span class="sc">==</span> <span class="dv">200</span>) {      <span class="co">#200 is the succesful response</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse the JSON response</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    parsed_data <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="fu">content</span>(response, <span class="st">"text"</span>, <span class="at">encoding =</span> <span class="st">"UTF-8"</span>))   <span class="co">#Encoding </span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This extracts a datframe</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    items <span class="ot">&lt;-</span> parsed_data<span class="sc">$</span>items</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Some data wrangling from the above step</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> items <span class="sc">%&gt;%</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">Date =</span> <span class="fu">as.Date</span>(<span class="fu">substr</span>(timestamp, <span class="dv">1</span>, <span class="dv">8</span>), <span class="st">"%Y%m%d"</span>)  <span class="co"># convert to date for the dataframe</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(Date, views) <span class="sc">%&gt;%</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Pageviews =</span> views)  <span class="co"># </span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(df)</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Failed to retrieve Wikipedia page views. HTTP status: "</span>, <span class="fu">status_code</span>(response))</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a><span class="co">#Simple tests</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a><span class="fu">get_wiki_pageviews</span>(<span class="st">"Tesla, Inc."</span>, <span class="st">"2024-09-01"</span> ,<span class="st">"2024-09-06"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Date Pageviews
1 2024-09-01      6318
2 2024-09-02      6512
3 2024-09-03      7264
4 2024-09-04      7328
5 2024-09-05      6981
6 2024-09-06      6563</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_wiki_pageviews</span>(<span class="st">"Donald Trump"</span>, <span class="st">"2024-09-01"</span> ,<span class="st">"2024-09-06"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Date Pageviews
1 2024-09-01     83113
2 2024-09-02     86343
3 2024-09-03     68567
4 2024-09-04     83610
5 2024-09-05     84318
6 2024-09-06     59051</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_wiki_pageviews</span>(<span class="st">"Chihuahua_(state)"</span>, <span class="st">"2024-09-01"</span> ,<span class="st">"2024-09-06"</span>) <span class="co">#Mateo's home state :)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Date Pageviews
1 2024-09-01       995
2 2024-09-02       997
3 2024-09-03      1021
4 2024-09-04      1015
5 2024-09-05       952
6 2024-09-06      1026</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_wiki_pageviews</span>(<span class="st">"Medellín"</span>, <span class="st">"2024-09-01"</span> ,<span class="st">"2024-09-06"</span>) <span class="co">#Camila's home city, which of course has more views than Chihuahua</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Date Pageviews
1 2024-09-01      1439
2 2024-09-02      1439
3 2024-09-03      1465
4 2024-09-04      1558
5 2024-09-05      1382
6 2024-09-06      1296</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_wiki_pageviews</span>(<span class="st">"Raleigh,_North_Carolina"</span>, <span class="st">"2024-09-01"</span> ,<span class="st">"2024-09-06"</span>) <span class="co">#And mitali's (Mitali wins)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Date Pageviews
1 2024-09-01      1729
2 2024-09-02      1878
3 2024-09-03      2068
4 2024-09-04      1620
5 2024-09-05      1589
6 2024-09-06      1696</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now pull the stock (ticker) data from YAHOO</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>get_stock_data <span class="ot">&lt;-</span> <span class="cf">function</span>(ticker, start_date, end_date) {</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  stock_data <span class="ot">&lt;-</span> <span class="fu">getSymbols</span>(</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    ticker, <span class="at">src =</span> <span class="st">"yahoo"</span>, <span class="at">from =</span> <span class="fu">as.Date</span>(start_date), <span class="at">to =</span> <span class="fu">as.Date</span>(end_date),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">auto.assign =</span> <span class="cn">FALSE</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  stock_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Date =</span> <span class="fu">index</span>(stock_data),</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Stock_Close =</span> <span class="fu">as.numeric</span>(<span class="fu">Cl</span>(stock_data))</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(stock_df)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co">#Some more simple tests for this</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="fu">get_stock_data</span>(<span class="st">"TSLA"</span>, <span class="st">"2024-09-01"</span> ,<span class="st">"2024-09-06"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Date Stock_Close
1 2024-09-03      210.60
2 2024-09-04      219.41
3 2024-09-05      230.17</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_stock_data</span>(<span class="st">"AAPL"</span>, <span class="st">"2024-09-01"</span> ,<span class="st">"2024-09-06"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Date Stock_Close
1 2024-09-03      222.77
2 2024-09-04      220.85
3 2024-09-05      222.38</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_stock_data</span>(<span class="st">"BBVA"</span>, <span class="st">"2024-09-01"</span> ,<span class="st">"2024-09-06"</span>)  <span class="co">#This works</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Date Stock_Close
1 2024-09-03       10.18
2 2024-09-04        9.98
3 2024-09-05       10.13</code></pre>
</div>
</div>
<section id="prepare-the-data" class="level3">
<h3 class="anchored" data-anchor-id="prepare-the-data">Prepare the data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">#This will take in the data created above</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>prepare_ml_data <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Lag the pageviews (or else we will predict the past)</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>) {   <span class="co">#I think 7 days are enough</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    data[[<span class="fu">paste0</span>(<span class="st">"Pageviews_lag"</span>, i)]] <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(data<span class="sc">$</span>Pageviews, <span class="at">n =</span> i)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Outcome will be 1 = UP up, 0 = DOWN or no change</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>Price_Change <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dplyr<span class="sc">::</span><span class="fu">lead</span>(data<span class="sc">$</span>Stock_Close) <span class="sc">&gt;</span> data<span class="sc">$</span>Stock_Close, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove rows with NA values</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(data)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="co">#Let's test it with our data</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>wiki_data <span class="ot">&lt;-</span> <span class="fu">get_wiki_pageviews</span>(<span class="st">"Tesla, Inc."</span>, <span class="st">"2024-01-01"</span>, <span class="st">"2024-03-01"</span>) <span class="co">#Make sure this is at least TWO months! (see below)</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>stock_data <span class="ot">&lt;-</span> <span class="fu">get_stock_data</span>(<span class="st">"TSLA"</span>, <span class="st">"2024-01-01"</span>, <span class="st">"2024-03-01"</span>)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>combined_data <span class="ot">&lt;-</span> <span class="fu">merge</span>(wiki_data, stock_data, <span class="at">by =</span> <span class="st">"Date"</span>)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply prepare_ml_data to real data</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>prepared_real_data <span class="ot">&lt;-</span> <span class="fu">prepare_ml_data</span>(combined_data)</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(prepared_real_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         Date Pageviews Stock_Close Pageviews_lag1 Pageviews_lag2
8  2024-01-11     16907      227.22          20037          17137
9  2024-01-12     16059      218.89          16907          20037
10 2024-01-16     19804      219.91          16059          16907
11 2024-01-17     21406      215.55          19804          16059
12 2024-01-18     19937      211.88          21406          19804
13 2024-01-19     21011      212.19          19937          21406
14 2024-01-22     20877      208.80          21011          19937
15 2024-01-23     18699      209.14          20877          21011
16 2024-01-24     20422      207.83          18699          20877
17 2024-01-25     21853      182.63          20422          18699
18 2024-01-26     18257      183.25          21853          20422
19 2024-01-29     18127      190.93          18257          21853
20 2024-01-30     19928      191.59          18127          18257
21 2024-01-31     25289      187.29          19928          18127
22 2024-02-01     15357      188.86          25289          19928
23 2024-02-02     13989      187.91          15357          25289
24 2024-02-05     12689      181.06          13989          15357
25 2024-02-06     11304      185.10          12689          13989
26 2024-02-07     10878      187.58          11304          12689
27 2024-02-08     10937      189.56          10878          11304
28 2024-02-09     10117      193.57          10937          10878
29 2024-02-12     11120      188.13          10117          10937
30 2024-02-13     13068      184.02          11120          10117
31 2024-02-14     10742      188.71          13068          11120
32 2024-02-15     14127      200.45          10742          13068
33 2024-02-16     12114      199.95          14127          10742
34 2024-02-20     17519      193.76          12114          14127
35 2024-02-21     11411      194.77          17519          12114
36 2024-02-22     12890      197.41          11411          17519
37 2024-02-23     14281      191.97          12890          11411
38 2024-02-26     14608      199.40          14281          12890
39 2024-02-27     15341      199.73          14608          14281
40 2024-02-28     15099      202.04          15341          14608
   Pageviews_lag3 Pageviews_lag4 Pageviews_lag5 Pageviews_lag6 Pageviews_lag7
8           11526          12066          12234          14228          14448
9           17137          11526          12066          12234          14228
10          20037          17137          11526          12066          12234
11          16907          20037          17137          11526          12066
12          16059          16907          20037          17137          11526
13          19804          16059          16907          20037          17137
14          21406          19804          16059          16907          20037
15          19937          21406          19804          16059          16907
16          21011          19937          21406          19804          16059
17          20877          21011          19937          21406          19804
18          18699          20877          21011          19937          21406
19          20422          18699          20877          21011          19937
20          21853          20422          18699          20877          21011
21          18257          21853          20422          18699          20877
22          18127          18257          21853          20422          18699
23          19928          18127          18257          21853          20422
24          25289          19928          18127          18257          21853
25          15357          25289          19928          18127          18257
26          13989          15357          25289          19928          18127
27          12689          13989          15357          25289          19928
28          11304          12689          13989          15357          25289
29          10878          11304          12689          13989          15357
30          10937          10878          11304          12689          13989
31          10117          10937          10878          11304          12689
32          11120          10117          10937          10878          11304
33          13068          11120          10117          10937          10878
34          10742          13068          11120          10117          10937
35          14127          10742          13068          11120          10117
36          12114          14127          10742          13068          11120
37          17519          12114          14127          10742          13068
38          11411          17519          12114          14127          10742
39          12890          11411          17519          12114          14127
40          14281          12890          11411          17519          12114
   Price_Change
8             0
9             1
10            0
11            0
12            1
13            0
14            1
15            0
16            0
17            1
18            1
19            1
20            0
21            1
22            0
23            0
24            1
25            1
26            1
27            1
28            0
29            0
30            1
31            1
32            0
33            0
34            1
35            1
36            0
37            1
38            1
39            1
40            0</code></pre>
</div>
</div>
</section>
<section id="train-and-test-the-model." class="level3">
<h3 class="anchored" data-anchor-id="train-and-test-the-model.">Train and test the model.</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>train_and_test <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use all rows except the last for training (I had to increase this or else the model fails!)</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  train_data <span class="ot">&lt;-</span> data[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">nrow</span>(data) <span class="sc">-</span> <span class="dv">1</span>), ]   </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  test_data <span class="ot">&lt;-</span> data[<span class="fu">nrow</span>(data), ]  <span class="co"># The last row is the test set to test it</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Force the outcome to factor (this crashed it earlier)</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  train_data<span class="sc">$</span>Price_Change <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(train_data<span class="sc">$</span>Price_Change)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Train logistic regression model</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    Price_Change <span class="sc">~</span> ., </span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> train_data[, <span class="fu">c</span>(<span class="st">"Price_Change"</span>, <span class="fu">paste0</span>(<span class="st">"Pageviews_lag"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>))],  <span class="co">#These are the VARIABLES, do NOT change to 1:nrow</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"glm"</span>, </span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"none"</span>)  <span class="co"># Disable cross-validation or it crashes</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict for the test day (last now)</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>  prediction <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> test_data[, <span class="fu">paste0</span>(<span class="st">"Pageviews_lag"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>), <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return the prediction and actual value</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction =</span> prediction,</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual =</span> test_data<span class="sc">$</span>Price_Change</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a><span class="fu">train_and_test</span>(prepared_real_data) <span class="co">#Wow! actually actually predicted :)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$prediction
[1] 0
Levels: 0 1

$actual
[1] 0</code></pre>
</div>
</div>
</section>
</section>
<section id="run-all-the-prior-for-some-wiki-pages-and-tickers-and-see-how-well-it-performs" class="level2">
<h2 class="anchored" data-anchor-id="run-all-the-prior-for-some-wiki-pages-and-tickers-and-see-how-well-it-performs">Run all the prior for some Wiki pages and tickers, and see how well it performs</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Do NOT run the next part unless necessary, as it makes TEN requests to each of the APIs
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stocks &lt;- c("TSLA", "AAPL", "MSFT", "GOOGL", "AMZN", "META", "NFLX", "NVDA", "BRK-B", "JNJ")</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># wiki_pages &lt;- c("Tesla, Inc.", "Apple_Inc.", "Microsoft", "Alphabet_Inc.", "Amazon_(company)", "Meta_Platforms", "Netflix", "Nvidia", "Berkshire_Hathaway", "Johnson_%26_Johnson")</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co"># start_date &lt;- "2024-03-01"</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># end_date &lt;- "2024-05-01"</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co"># # Loop through associations</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co"># results &lt;- lapply(1:length(stocks), function(i) {</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   stock &lt;- stocks[i]</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   wiki_page &lt;- wiki_pages[i]</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   # Pull data</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   wiki_data &lt;- get_wiki_pageviews(wiki_page, start_date, end_date)</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   stock_data &lt;- get_stock_data(stock, start_date, end_date)</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   # Merge data</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   combined_data &lt;- merge(wiki_data, stock_data, by = "Date")</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co">#   # Prepare data</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="co">#   prepared_data &lt;- prepare_ml_data(combined_data)</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a><span class="co">#   # Train and test</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   train_and_test(prepared_data)</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="co"># })</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a><span class="co"># # Print results</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="co"># results</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a><span class="co"># # The model worked on 6/10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We tested our model with 20 different Wiki sites and stocks, and ended up with an accuracy of 60%.</p>
</section>
<section id="part-2" class="level2">
<h2 class="anchored" data-anchor-id="part-2">Part 2</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define UI for the Shiny app</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="co"># I have found and fixed the extra parenthesis that we had somewhere</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(      <span class="co">#For a responsive web layout</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">titlePanel</span>(<span class="st">"Wikipedia &amp; Stock Price Correlation"</span>),     <span class="co">#This goes at the top of the app</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Add a description of the machine learning model</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="fu">fluidRow</span>(</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column</span>(<span class="dv">12</span>,</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>         <span class="fu">h4</span>(<span class="st">"About This Tool"</span>),</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>         <span class="fu">p</span>(<span class="st">"This tool uses a machine learning algorithm (logistic regression) to analyze the relationship </span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="st">             between Wikipedia pageviews and stock price movements. It uses the number of Wikipedia pageviews </span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="st">             for the past 7 days (lagged data) to predict whether the stock price will go up or down </span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="st">             on the last day of the selected date range."</span>),</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>         <span class="fu">div</span>(</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">style =</span> <span class="st">"background-color: #f2f2f2; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold;"</span>,</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>           <span class="st">"For best results, select a minimum range of 3 months."</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>         ))),</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#This is where the user will input Wiki and stock -  For now let's stick to TESLA</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sidebarLayout</span>(</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sidebarPanel</span>(</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">textInput</span>(<span class="st">"stock"</span>, <span class="st">"Enter Stock Ticker (e.g., TSLA)"</span>, <span class="st">"TSLA"</span>),</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">textInput</span>(<span class="st">"wiki_page"</span>, <span class="st">"Enter Wikipedia Page (e.g., Tesla, Inc.)"</span>, <span class="st">"Tesla, Inc."</span>),</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">dateRangeInput</span>(<span class="st">"date_range"</span>, <span class="st">"Select Date Range"</span>,</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>                     <span class="at">start =</span> <span class="st">"2024-01-01"</span>, <span class="at">end =</span> <span class="fu">Sys.Date</span>())</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">#This is  the output</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mainPanel</span>(</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plotOutput</span>(<span class="st">"plot"</span>),</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">textOutput</span>(<span class="st">"error"</span>),</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">verbatimTextOutput</span>(<span class="st">"model_summary"</span>),</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">uiOutput</span>(<span class="st">"prediction"</span>)  <span class="co"># Updated to handle dynamic banners</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the training function outside the server logic</span></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>train_model <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>  predictors <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Pageviews_lag"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>)</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>  train_control <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>, <span class="at">number =</span> <span class="dv">5</span>)</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert Price_Change to a factor</span></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>Price_Change <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data<span class="sc">$</span>Price_Change)</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>    Price_Change <span class="sc">~</span> ., </span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data[, <span class="fu">c</span>(<span class="st">"Price_Change"</span>, predictors)], </span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"glm"</span>, </span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">trControl =</span> train_control</span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(model)</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a><span class="do">###########################################</span></span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a><span class="do">##### And define the server logic #########</span></span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output, session) {</span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reactive expression to get data based on user inputs</span></span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">req</span>(input<span class="sc">$</span>stock, input<span class="sc">$</span>wiki_page, input<span class="sc">$</span>date_range)</span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fetch Wikipedia data</span></span>
<span id="cb48-70"><a href="#cb48-70" aria-hidden="true" tabindex="-1"></a>    wiki_data <span class="ot">&lt;-</span> <span class="fu">get_wiki_pageviews</span>(input<span class="sc">$</span>wiki_page, input<span class="sc">$</span>date_range[<span class="dv">1</span>], input<span class="sc">$</span>date_range[<span class="dv">2</span>])</span>
<span id="cb48-71"><a href="#cb48-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(wiki_data)) {</span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a>      output<span class="sc">$</span>error <span class="ot">&lt;-</span> <span class="fu">renderText</span>(<span class="st">"Error: Unable to retrieve Wikipedia page views."</span>)</span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb48-74"><a href="#cb48-74" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-75"><a href="#cb48-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fetch stock data</span></span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a>    stock_data <span class="ot">&lt;-</span> <span class="fu">get_stock_data</span>(input<span class="sc">$</span>stock, input<span class="sc">$</span>date_range[<span class="dv">1</span>], input<span class="sc">$</span>date_range[<span class="dv">2</span>])</span>
<span id="cb48-78"><a href="#cb48-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(stock_data)) {</span>
<span id="cb48-79"><a href="#cb48-79" aria-hidden="true" tabindex="-1"></a>      output<span class="sc">$</span>error <span class="ot">&lt;-</span> <span class="fu">renderText</span>(<span class="st">"Error: Unable to retrieve stock data."</span>)</span>
<span id="cb48-80"><a href="#cb48-80" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb48-81"><a href="#cb48-81" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-82"><a href="#cb48-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-83"><a href="#cb48-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge and normalize data</span></span>
<span id="cb48-84"><a href="#cb48-84" aria-hidden="true" tabindex="-1"></a>    combined_data <span class="ot">&lt;-</span> <span class="fu">merge</span>(wiki_data, stock_data, <span class="at">by =</span> <span class="st">"Date"</span>)</span>
<span id="cb48-85"><a href="#cb48-85" aria-hidden="true" tabindex="-1"></a>    combined_data<span class="sc">$</span>Pageviews_norm <span class="ot">&lt;-</span> (combined_data<span class="sc">$</span>Pageviews <span class="sc">-</span> <span class="fu">min</span>(combined_data<span class="sc">$</span>Pageviews)) <span class="sc">/</span></span>
<span id="cb48-86"><a href="#cb48-86" aria-hidden="true" tabindex="-1"></a>      (<span class="fu">max</span>(combined_data<span class="sc">$</span>Pageviews) <span class="sc">-</span> <span class="fu">min</span>(combined_data<span class="sc">$</span>Pageviews))</span>
<span id="cb48-87"><a href="#cb48-87" aria-hidden="true" tabindex="-1"></a>    combined_data<span class="sc">$</span>Stock_Close_norm <span class="ot">&lt;-</span> (combined_data<span class="sc">$</span>Stock_Close <span class="sc">-</span> <span class="fu">min</span>(combined_data<span class="sc">$</span>Stock_Close)) <span class="sc">/</span></span>
<span id="cb48-88"><a href="#cb48-88" aria-hidden="true" tabindex="-1"></a>      (<span class="fu">max</span>(combined_data<span class="sc">$</span>Stock_Close) <span class="sc">-</span> <span class="fu">min</span>(combined_data<span class="sc">$</span>Stock_Close))</span>
<span id="cb48-89"><a href="#cb48-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-90"><a href="#cb48-90" aria-hidden="true" tabindex="-1"></a>    output<span class="sc">$</span>error <span class="ot">&lt;-</span> <span class="fu">renderText</span>(<span class="st">""</span>)  <span class="co"># Clear error message</span></span>
<span id="cb48-91"><a href="#cb48-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(combined_data)</span>
<span id="cb48-92"><a href="#cb48-92" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb48-93"><a href="#cb48-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-94"><a href="#cb48-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reactive expression to prepare data</span></span>
<span id="cb48-95"><a href="#cb48-95" aria-hidden="true" tabindex="-1"></a>  prepared_data <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb48-96"><a href="#cb48-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">req</span>(<span class="fu">data</span>())</span>
<span id="cb48-97"><a href="#cb48-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prepare_ml_data</span>(<span class="fu">data</span>())</span>
<span id="cb48-98"><a href="#cb48-98" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb48-99"><a href="#cb48-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-100"><a href="#cb48-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reactive expression to train the model</span></span>
<span id="cb48-101"><a href="#cb48-101" aria-hidden="true" tabindex="-1"></a>  trained_model <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb48-102"><a href="#cb48-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">req</span>(<span class="fu">prepared_data</span>())</span>
<span id="cb48-103"><a href="#cb48-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">train_model</span>(<span class="fu">prepared_data</span>())</span>
<span id="cb48-104"><a href="#cb48-104" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb48-105"><a href="#cb48-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-106"><a href="#cb48-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Display model summary (I'VE MODIFIED THIS TO MAKE THE OUTPUT MORE SIMPLE!)</span></span>
<span id="cb48-107"><a href="#cb48-107" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>model_summary <span class="ot">&lt;-</span> <span class="fu">renderPrint</span>({</span>
<span id="cb48-108"><a href="#cb48-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">req</span>(<span class="fu">trained_model</span>())</span>
<span id="cb48-109"><a href="#cb48-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-110"><a href="#cb48-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get model details</span></span>
<span id="cb48-111"><a href="#cb48-111" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">trained_model</span>()</span>
<span id="cb48-112"><a href="#cb48-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-113"><a href="#cb48-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Display a simplified version of the model's key details</span></span>
<span id="cb48-114"><a href="#cb48-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Model Training Complete</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-115"><a href="#cb48-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Cross-validation Accuracy:"</span>, <span class="fu">round</span>(<span class="fu">max</span>(model<span class="sc">$</span>results<span class="sc">$</span>Accuracy, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-116"><a href="#cb48-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Key Predictors:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-117"><a href="#cb48-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(model<span class="sc">$</span>finalModel<span class="sc">$</span>coefficients)</span>
<span id="cb48-118"><a href="#cb48-118" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb48-119"><a href="#cb48-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-120"><a href="#cb48-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict next day's price movement</span></span>
<span id="cb48-121"><a href="#cb48-121" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>prediction <span class="ot">&lt;-</span> <span class="fu">renderUI</span>({</span>
<span id="cb48-122"><a href="#cb48-122" aria-hidden="true" tabindex="-1"></a>    <span class="fu">req</span>(<span class="fu">trained_model</span>(), <span class="fu">prepared_data</span>())</span>
<span id="cb48-123"><a href="#cb48-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-124"><a href="#cb48-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the prediction</span></span>
<span id="cb48-125"><a href="#cb48-125" aria-hidden="true" tabindex="-1"></a>    new_data <span class="ot">&lt;-</span> <span class="fu">prepared_data</span>()[<span class="fu">nrow</span>(<span class="fu">prepared_data</span>()), <span class="fu">paste0</span>(<span class="st">"Pageviews_lag"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb48-126"><a href="#cb48-126" aria-hidden="true" tabindex="-1"></a>    prediction <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="fu">trained_model</span>(), <span class="at">newdata =</span> new_data)</span>
<span id="cb48-127"><a href="#cb48-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-128"><a href="#cb48-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define message and color</span></span>
<span id="cb48-129"><a href="#cb48-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (prediction <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb48-130"><a href="#cb48-130" aria-hidden="true" tabindex="-1"></a>      message <span class="ot">&lt;-</span> <span class="st">"Predicted Price Movement: UP"</span></span>
<span id="cb48-131"><a href="#cb48-131" aria-hidden="true" tabindex="-1"></a>      color <span class="ot">&lt;-</span> <span class="st">"#d4edda"</span>  <span class="co"># Light green</span></span>
<span id="cb48-132"><a href="#cb48-132" aria-hidden="true" tabindex="-1"></a>      text_color <span class="ot">&lt;-</span> <span class="st">"#155724"</span>  <span class="co"># Dark green text</span></span>
<span id="cb48-133"><a href="#cb48-133" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb48-134"><a href="#cb48-134" aria-hidden="true" tabindex="-1"></a>      message <span class="ot">&lt;-</span> <span class="st">"Predicted Price Movement: DOWN"</span></span>
<span id="cb48-135"><a href="#cb48-135" aria-hidden="true" tabindex="-1"></a>      color <span class="ot">&lt;-</span> <span class="st">"#f8d7da"</span>  <span class="co"># Light red</span></span>
<span id="cb48-136"><a href="#cb48-136" aria-hidden="true" tabindex="-1"></a>      text_color <span class="ot">&lt;-</span> <span class="st">"#721c24"</span>  <span class="co"># Dark red text</span></span>
<span id="cb48-137"><a href="#cb48-137" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-138"><a href="#cb48-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-139"><a href="#cb48-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a styled banner</span></span>
<span id="cb48-140"><a href="#cb48-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">div</span>(</span>
<span id="cb48-141"><a href="#cb48-141" aria-hidden="true" tabindex="-1"></a>      <span class="at">style =</span> <span class="fu">paste</span>(</span>
<span id="cb48-142"><a href="#cb48-142" aria-hidden="true" tabindex="-1"></a>        <span class="st">"background-color:"</span>, color, <span class="st">";"</span>,</span>
<span id="cb48-143"><a href="#cb48-143" aria-hidden="true" tabindex="-1"></a>        <span class="st">"color:"</span>, text_color, <span class="st">";"</span>,</span>
<span id="cb48-144"><a href="#cb48-144" aria-hidden="true" tabindex="-1"></a>        <span class="st">"padding: 10px;"</span>,</span>
<span id="cb48-145"><a href="#cb48-145" aria-hidden="true" tabindex="-1"></a>        <span class="st">"border-radius: 5px;"</span>,</span>
<span id="cb48-146"><a href="#cb48-146" aria-hidden="true" tabindex="-1"></a>        <span class="st">"font-weight: bold;"</span>,</span>
<span id="cb48-147"><a href="#cb48-147" aria-hidden="true" tabindex="-1"></a>        <span class="st">"text-align: center;"</span></span>
<span id="cb48-148"><a href="#cb48-148" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb48-149"><a href="#cb48-149" aria-hidden="true" tabindex="-1"></a>      message</span>
<span id="cb48-150"><a href="#cb48-150" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb48-151"><a href="#cb48-151" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb48-152"><a href="#cb48-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-153"><a href="#cb48-153" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot output</span></span>
<span id="cb48-154"><a href="#cb48-154" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>plot <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>({</span>
<span id="cb48-155"><a href="#cb48-155" aria-hidden="true" tabindex="-1"></a>    <span class="fu">req</span>(<span class="fu">data</span>())</span>
<span id="cb48-156"><a href="#cb48-156" aria-hidden="true" tabindex="-1"></a>    combined_data <span class="ot">&lt;-</span> <span class="fu">data</span>()</span>
<span id="cb48-157"><a href="#cb48-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(combined_data, <span class="fu">aes</span>(<span class="at">x =</span> Date)) <span class="sc">+</span></span>
<span id="cb48-158"><a href="#cb48-158" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Pageviews_norm, <span class="at">color =</span> <span class="st">"Pageviews"</span>)) <span class="sc">+</span></span>
<span id="cb48-159"><a href="#cb48-159" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Stock_Close_norm, <span class="at">color =</span> <span class="st">"Stock Price"</span>)) <span class="sc">+</span></span>
<span id="cb48-160"><a href="#cb48-160" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(</span>
<span id="cb48-161"><a href="#cb48-161" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Normalized Wikipedia Pageviews and Stock Price for"</span>, input<span class="sc">$</span>stock),</span>
<span id="cb48-162"><a href="#cb48-162" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb48-163"><a href="#cb48-163" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Normalized Scale (0-1)"</span></span>
<span id="cb48-164"><a href="#cb48-164" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb48-165"><a href="#cb48-165" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Pageviews"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"Stock Price"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb48-166"><a href="#cb48-166" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb48-167"><a href="#cb48-167" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb48-168"><a href="#cb48-168" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb48-169"><a href="#cb48-169" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-170"><a href="#cb48-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-171"><a href="#cb48-171" aria-hidden="true" tabindex="-1"></a><span class="fu">shinyApp</span>(<span class="at">ui =</span> ui, <span class="at">server =</span> server)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><iframe data-deferred-src="app79ff6f20b2fb181948700c572132d396/?w=&amp;__subapp__=1" width="100%" height="400" class="shiny-frame shiny-frame-deferred"></iframe></p>
</div>
</div>
</section>
<section id="programming-paradigms" class="level2">
<h2 class="anchored" data-anchor-id="programming-paradigms">Programming Paradigms</h2>
<p>The project mainly focused on two programming paradigms: functional programming and machine learning. For functional programming, deployment of the final product (an app) was facilitated by the use of multiple functions. For example, one function extracted, for a specified Wikipedia page, in a specific time interval, the number of views, and turned it into a data frame. A second function served a similar purpose to extract stock prices for a specific company. Using Yahoo financial, the function extracted, for a specified date interval, the ticker value (ie, stock price) and convert it to a data frame. A different function will prepare and train the data for machine learning purposes.</p>
<p>Evidently, the second programming paradigm will be machine learning. The pageviews (lagged) will be the predictors, and the stock price the outcome. Based on this, the model will output a simple final prediction of whether the price will increase or decrease.</p>
</section>
<section id="limitations-and-future-work" class="level2">
<h2 class="anchored" data-anchor-id="limitations-and-future-work">Limitations and Future Work</h2>
<p>Our product has some limitations in terms of usability and accessibility. The stock market calculator only predicts what happens the following day. This is limiting for those who want to use our stock tracker to properly invest in stocks weeks or months in advance. Another limitation is that the calculator requires some statistical knowledge to interpret the outputs. Namely, the cross-validation percentage and the beta values of our output. Lastly, the stock itself is volatile, and changes occur unexpectedly, so relying on this calculator might not produce the best results if one was to use this on the day of a major event for a certain company or individual.</p>
<p>For future work, we would like to explore testing a more accurate predictive capability. Additionally, if resources allow, we would like to refine the data with sources that better explore sentiments such as using Twitter or Instagram.</p>

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-wikimedia" class="csl-entry" role="listitem">
Foundation, Wikimedia. n.d. <span>“Wikimedia REST API.”</span>
</div>
<div id="ref-huang2020" class="csl-entry" role="listitem">
Huang, M. Y., R. R. Rojas, and P. D. Convery. 2020. <span>“Forecasting Stock Market Movements Using Google Trend Searches.”</span> <em>Empirical Economics</em> 59: 2821–39. <a href="https://doi.org/10.1007/s00181-019-01725-1">https://doi.org/10.1007/s00181-019-01725-1</a>.
</div>
<div id="ref-shivers" class="csl-entry" role="listitem">
Shivers, D. n.d. <span>“Exploring the Relationship Between Google Trends Data and Stock Price Data.”</span> UCSD.
</div>
<div id="ref-szczygielski2024" class="csl-entry" role="listitem">
Szczygielski, Jan Jakub, Ailie Charteris, Princess Rutendo Bwanya, and Janusz Brzeszczyński. 2024. <span>“Google Search Trends and Stock Markets: Sentiment, Attention or Uncertainty?”</span> <em>International Review of Financial Analysis</em> 91. <a href="https://doi.org/10.1016/j.irfa.2023.102549">https://doi.org/10.1016/j.irfa.2023.102549</a>.
</div>
<div id="ref-yahoo" class="csl-entry" role="listitem">
Yahoo. n.d. <span>“Yahoo Finance.”</span>
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>